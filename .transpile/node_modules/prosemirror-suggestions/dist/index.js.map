{"version":3,"file":"index.js","sources":["../src/suggestions.js","../src/tags.js","../src/mentions.js"],"sourcesContent":["import { Plugin, PluginKey } from 'prosemirror-state';\nimport { Decoration, DecorationSet } from 'prosemirror-view';\n\n/**\n * Create a matcher that matches when a specific character is typed. Useful for @mentions and #tags.\n *\n * @param {String} char\n * @param {Boolean} allowSpaces\n * @returns {function(*)}\n */\nexport function triggerCharacter(char, allowSpaces = false) {\n  /**\n   * @param {ResolvedPos} $position\n   */\n  return $position => {\n    // Matching expressions used for later\n    const suffix = new RegExp(`\\\\s${char}$`);\n    const regexp = allowSpaces\n      ? new RegExp(`${char}.*?(?=\\\\s${char}|$)`, 'g')\n      : new RegExp(`(?:^)?${char}[^\\\\s${char}]*`, 'g');\n\n    // Lookup the boundaries of the current node\n    const textFrom = $position.before();\n    const textTo = $position.end();\n\n    const text = $position.doc.textBetween(textFrom, textTo, '\\0', '\\0');\n\n    let match;\n\n    while (match = regexp.exec(text)) {\n      // JavaScript doesn't have lookbehinds; this hacks a check that first character is \" \" or the line beginning\n      const prefix = match.input.slice(Math.max(0, match.index - 1), match.index);\n      if (!/^[\\s\\0]?$/.test(prefix)) {\n        continue;\n      }\n\n      // The absolute position of the match in the document\n      const from = match.index + $position.start();\n      let to = from + match[0].length;\n\n      // Edge case handling; if spaces are allowed and we're directly in between two triggers\n      if (allowSpaces && suffix.test(text.slice(to - 1, to + 1))) {\n        match[0] += ' ';\n        to++;\n      }\n\n      // If the $position is located within the matched substring, return that range\n      if (from < $position.pos && to >= $position.pos) {\n        return { range: { from, to }, text: match[0] };\n      }\n    }\n  }\n}\n\n/**\n * @returns {Plugin}\n */\nexport function suggestionsPlugin({\n  matcher = triggerCharacter('#'),\n  suggestionClass = 'ProseMirror-suggestion',\n  onEnter = () => false,\n  onChange = () => false,\n  onExit = () => false,\n  onKeyDown = () => false,\n  escapeOnSelectionChange = true,\n  escapeKeys = ['Escape', 'ArrowRight', 'ArrowLeft'],\n  debug = false,\n}) {\n  return new Plugin({\n    key: new PluginKey('suggestions'),\n\n    view() {\n      return {\n        update: (view, prevState) => {\n          const prev = this.key.getState(prevState);\n          const next = this.key.getState(view.state);\n\n          // See how the state changed\n          const moved = prev.active && next.active && prev.range.from !== next.range.from;\n          const started = !prev.active && next.active;\n          const stopped = prev.active && !next.active;\n          const changed = !started && !stopped && prev.text !== next.text;\n\n          // Trigger the hooks when necessary\n          if (stopped || moved) onExit({ view, range: prev.range, text: prev.text });\n          if (changed && !moved) onChange({ view, range: next.range, text: next.text });\n          if (started || moved) onEnter({ view, range: next.range, text: next.text });\n        },\n      };\n    },\n\n    state: {\n      /**\n       * Initialize the plugin's internal state.\n       *\n       * @returns {Object}\n       */\n      init() {\n        return {\n          active: false,\n          range: {},\n          text: null,\n        };\n      },\n\n      /**\n       * Apply changes to the plugin state from a view transaction.\n       *\n       * @param {Transaction} tr\n       * @param {Object} prev\n       *\n       * @returns {Object}\n       */\n      apply(tr, prev) {\n        const meta = tr.getMeta(this.key);\n        if (meta) { return meta; }\n        const { selection } = tr;\n        const next = { ...prev };\n        if (escapeOnSelectionChange && !tr.docChanged && tr.selectionSet) { // allow user to escape with arrow keys\n          next.active = false;\n        } else if (selection.from === selection.to) { // We can only be suggesting if there is no selection\n          // Reset active state if we just left the previous suggestion range\n          if (selection.from < prev.range.from || selection.from > prev.range.to) {\n            next.active = false;\n          }\n\n          // Try to match against where our cursor currently is\n          const $position = selection.$from;\n          const match = matcher($position);\n\n          // If we found a match, update the current state to show it\n          if (match) {\n            next.active = true;\n            next.range = match.range;\n            next.text = match.text;\n          } else {\n            next.active = false;\n          }\n        } else {\n          next.active = false;\n        }\n\n        // Make sure to empty the range if suggestion is inactive\n        if (!next.active) {\n          next.range = {};\n          next.text = null;\n        }\n\n        return next;\n      },\n    },\n\n    props: {\n      /**\n       * Call the keydown hook if suggestion is active.\n       *\n       * @param view\n       * @param event\n       * @returns {boolean}\n       */\n      handleKeyDown(view, event) {\n        const { active } = this.getState(view.state);\n\n        if (!active) return false\n\n        if (escapeKeys.includes(event.key)) {\n          let tr = view.state.tr.setMeta(this.key, {\n            active: false,\n            range: {},\n            text: null\n          });\n          view.dispatch(tr);\n          return false;\n        }\n\n        return onKeyDown({ view, event });\n      },\n\n      /**\n       * Setup decorator on the currently active suggestion.\n       *\n       * @param {EditorState} editorState\n       *\n       * @returns {?DecorationSet}\n       */\n      decorations(editorState) {\n        const { active, range } = this.getState(editorState);\n\n        if (!active) return null;\n\n        return DecorationSet.create(editorState.doc, [\n          Decoration.inline(range.from, range.to, {\n            nodeName: 'span',\n            class: suggestionClass,\n            style: debug ? 'background: rgba(0, 0, 255, 0.05); color: blue; border: 2px solid blue;' : null,\n          }),\n        ]);\n      },\n    },\n  });\n}\n","/**\n * @type {NodeSpec}\n */\nexport const tagNodeSpec = {\n  attrs: {\n    id: {},\n  },\n\n  group: 'inline',\n  inline: true,\n  selectable: false,\n  atom: true,\n\n  /**\n   * @param {Node} node\n   */\n  toDOM: node => ['span', {\n    'class': 'tag',\n    'data-tag-id': node.attrs.id,\n  }, node.attrs.id],\n\n  parseDOM: [{\n    tag: 'span[data-tag-id]',\n\n    /**\n     * @param {Element} dom\n     * @returns {{id: string}}\n     */\n    getAttrs: dom => {\n      const id = dom.getAttribute('data-tag-id');\n\n      return { id };\n    },\n  }],\n};\n\n/**\n * @param {OrderedMap} nodes\n * @returns {OrderedMap}\n */\nexport function addTagNodes(nodes) {\n  return nodes.append({\n    tag: tagNodeSpec,\n  });\n}\n","/**\n * @type {NodeSpec}\n */\nexport const mentionNodeSpec = {\n  attrs: {\n    type: {},\n    id: {},\n    label: {},\n  },\n\n  group: 'inline',\n  inline: true,\n  selectable: false,\n  atom: true,\n\n  toDOM: node => ['span', {\n    'class': 'mention',\n    'data-mention-type': node.attrs.type,\n    'data-mention-id': node.attrs.id,\n  }, `@${node.attrs.label}`],\n\n  parseDOM: [{\n    tag: 'span[data-mention-type][data-mention-id]',\n\n    /**\n     * @param {Element} dom\n     * @returns {{type: string, id: string, label: string}}\n     */\n    getAttrs: dom => {\n      const type = dom.getAttribute('data-mention-type');\n      const id = dom.getAttribute('data-mention-id');\n      const label = dom.innerText;\n\n      return { type, id, label };\n    },\n  }],\n};\n\n/**\n * @param {OrderedMap} nodes\n * @returns {OrderedMap}\n */\nexport function addMentionNodes(nodes) {\n  return nodes.append({\n    mention: mentionNodeSpec,\n  });\n}\n"],"names":["const","let","Plugin","PluginKey","this","DecorationSet","Decoration"],"mappings":"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"}